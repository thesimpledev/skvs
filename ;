package main

import (
	"net"
)

func (s *server) handlePacket(clientAddr *net.UDPAddr, data []byte) {
	payload, err := s.encryptor.Decrypt(data)
	if err != nil {
		s.log.Error("Decrypt failed", "Err", err)
		s.sendMessage([]byte("ERROR: failed to process message"), s.conn, clientAddr)
		return
	}

	response, err := s.app.processMessage(payload)
	if err != nil {
		s.log.Error("failed to process message", "err", err)
		s.sendMessage([]byte("ERROR: failed to process message"), s.conn, clientAddr)
		return
	}

	encryptedResponse, err := s.encryptor.Encrypt(response)
	if err != nil {
		s.log.Error("Encryption failed", "Err", err)
		s.sendMessage([]byte("ERROR: failed to process message"), s.conn, clientAddr)
		return
	}

	s.sendMessage(encryptedResponse, s.conn, clientAddr)
}

func (app *server) sendMessage(message []byte, server *net.UDPConn, clientAddr *net.UDPAddr) {
	_, err := server.WriteToUDP(message, clientAddr)
	if err != nil {
		app.log.Error("failed to write response", "err", err)
		return
	}
}
